{% extends "base.html" %}

{% block title %}Scene Builder - Video Generation System{% endblock %}

{% block content %}
<div x-data="sceneBuilder()" x-cloak>
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2 text-gray-500">
            <li><a href="/" class="hover:text-purple-600">Home</a></li>
            <li>→</li>
            <li class="text-purple-600 font-medium">Scene Builder</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">🧙 Advanced Scene Builder</h2>
        <p class="text-gray-600">Build your video by adding and arranging scenes with complete control</p>
    </div>

    <!-- Progress Steps -->
    <div class="mb-8 bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center font-bold">1</div>
                <span class="font-medium text-gray-700">Set Video Info</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full" :class="scenes.length > 0 ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-500'" class="flex items-center justify-center font-bold">2</div>
                <span class="font-medium" :class="scenes.length > 0 ? 'text-gray-700' : 'text-gray-400'">Add Scenes</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold">3</div>
                <span class="font-medium text-gray-400">Generate</span>
            </div>
        </div>
    </div>

    <!-- Video Metadata -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Video Information</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Video ID</label>
                <input type="text"
                       x-model="videoSet.set_id"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                       placeholder="my_video">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Video Title</label>
                <input type="text"
                       x-model="videoSet.set_name"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                       placeholder="My Awesome Video">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Accent Color</label>
                <select x-model="videoSet.accent_color"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                    <option value="blue">Blue - Professional, trustworthy (corporate, finance)</option>
                    <option value="purple">Purple - Premium, sophisticated (high-end, creative)</option>
                    <option value="orange">Orange - Energetic, creative (marketing, youth)</option>
                    <option value="green">Green - Success, growth (environmental, health)</option>
                    <option value="pink">Pink - Playful, modern (youth, lifestyle)</option>
                    <option value="cyan">Cyan - Tech, innovation (technology, science)</option>
                </select>
                <div class="mt-2 flex items-center gap-2">
                    <div class="w-6 h-6 rounded"
                         :class="{
                            'bg-blue-500': videoSet.accent_color === 'blue',
                            'bg-purple-500': videoSet.accent_color === 'purple',
                            'bg-orange-500': videoSet.accent_color === 'orange',
                            'bg-green-500': videoSet.accent_color === 'green',
                            'bg-pink-500': videoSet.accent_color === 'pink',
                            'bg-cyan-500': videoSet.accent_color === 'cyan'
                         }"></div>
                    <span class="text-xs text-gray-500 italic">Color preview</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Multilingual Settings -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Multilingual Settings</h3>
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox"
                       x-model="multilingualEnabled"
                       class="w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-2 focus:ring-primary-500">
                <span class="text-sm font-medium text-gray-700">Enable Multilingual Mode</span>
            </label>
        </div>

        <div x-show="multilingualEnabled" class="space-y-6">
            <!-- Source Language -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Source Language
                    <span class="text-xs text-gray-500">(Original content language)</span>
                </label>
                <select x-model="sourceLanguage"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="it">Italian</option>
                    <option value="pt">Portuguese</option>
                    <option value="nl">Dutch</option>
                    <option value="ru">Russian</option>
                    <option value="ja">Japanese</option>
                    <option value="zh">Chinese</option>
                    <option value="ko">Korean</option>
                    <option value="ar">Arabic</option>
                    <option value="hi">Hindi</option>
                    <option value="tr">Turkish</option>
                    <option value="pl">Polish</option>
                    <option value="sv">Swedish</option>
                    <option value="no">Norwegian</option>
                    <option value="da">Danish</option>
                    <option value="fi">Finnish</option>
                    <option value="el">Greek</option>
                    <option value="he">Hebrew</option>
                    <option value="th">Thai</option>
                    <option value="vi">Vietnamese</option>
                    <option value="id">Indonesian</option>
                    <option value="ms">Malay</option>
                    <option value="tl">Filipino</option>
                    <option value="cs">Czech</option>
                    <option value="hu">Hungarian</option>
                </select>
            </div>

            <!-- Target Languages -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    Target Languages
                    <span class="text-xs text-gray-500">(Videos will be generated for each selected language)</span>
                </label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="en" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">English</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="es" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Spanish</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="fr" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">French</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="de" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">German</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="it" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Italian</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="pt" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Portuguese</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="nl" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Dutch</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="ru" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Russian</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="ja" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Japanese</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="zh" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Chinese</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="ko" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Korean</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="ar" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Arabic</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="hi" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Hindi</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="tr" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Turkish</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="pl" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Polish</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="sv" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Swedish</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="no" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Norwegian</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="da" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Danish</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="fi" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Finnish</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="el" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Greek</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="he" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Hebrew</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="th" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Thai</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="vi" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Vietnamese</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="id" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Indonesian</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="ms" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Malay</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="tl" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Filipino</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="cs" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Czech</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer p-2 hover:bg-gray-50 rounded">
                        <input type="checkbox" value="hu" x-model="targetLanguages" class="w-4 h-4 text-primary-600 border-gray-300 rounded">
                        <span class="text-sm">Hungarian</span>
                    </label>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    Selected: <span x-text="targetLanguages.length"></span> language(s)
                </p>
            </div>

            <!-- Per-Language Voice Assignment -->
            <div x-show="targetLanguages.length > 0">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    Voice Assignment per Language
                    <span class="text-xs text-gray-500">(Optional: customize voice for each target language)</span>
                </label>
                <div class="space-y-3">
                    <template x-for="lang in targetLanguages" :key="lang">
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-700 w-32" x-text="getLanguageName(lang)"></span>
                            <select x-model="languageVoices[lang]"
                                    class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                                <option value="">Default Voice</option>
                                <option value="male">Andrew (Male)</option>
                                <option value="male_warm">Brandon (Male Warm)</option>
                                <option value="female">Aria (Female)</option>
                                <option value="female_friendly">Ava (Female Friendly)</option>
                            </select>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Info Box -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div class="flex-1">
                        <h4 class="text-sm font-medium text-blue-900 mb-1">How Multilingual Mode Works</h4>
                        <ul class="text-xs text-blue-800 space-y-1">
                            <li>Content will be automatically translated from source to each target language</li>
                            <li>Separate video files will be generated for each language</li>
                            <li>AI narration adapts to each language's pronunciation and rhythm</li>
                            <li>Visual elements remain consistent across all language versions</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scene List -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Left: Scene Types -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Add Scene</h3>

                <!-- General Scenes -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-gray-500 uppercase mb-3">General</h4>
                    <div class="space-y-2">
                        <button @click="addScene('title')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">🎬</span>
                            <span class="font-medium">Title Slide</span>
                        </button>
                        <button @click="addScene('command')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">💻</span>
                            <span class="font-medium">Command/Code</span>
                        </button>
                        <button @click="addScene('list')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">📋</span>
                            <span class="font-medium">List Items</span>
                        </button>
                        <button @click="addScene('outro')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">✅</span>
                            <span class="font-medium">Outro/CTA</span>
                        </button>
                        <button @click="addScene('code_comparison')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">🔄</span>
                            <span class="font-medium">Code Comparison</span>
                        </button>
                        <button @click="addScene('quote')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">💬</span>
                            <span class="font-medium">Quote</span>
                        </button>
                    </div>
                </div>

                <!-- Educational Scenes -->
                <div>
                    <h4 class="text-sm font-medium text-gray-500 uppercase mb-3">Educational</h4>
                    <div class="space-y-2">
                        <button @click="addScene('learning_objectives')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">🎯</span>
                            <span class="font-medium">Learning Objectives</span>
                        </button>
                        <button @click="addScene('problem')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">❓</span>
                            <span class="font-medium">Problem</span>
                        </button>
                        <button @click="addScene('solution')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">💡</span>
                            <span class="font-medium">Solution</span>
                        </button>
                        <button @click="addScene('checkpoint')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">✓</span>
                            <span class="font-medium">Checkpoint</span>
                        </button>
                        <button @click="addScene('quiz')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">📝</span>
                            <span class="font-medium">Quiz</span>
                        </button>
                        <button @click="addScene('exercise')"
                                class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <span class="text-xl mr-2">💪</span>
                            <span class="font-medium">Exercise</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Scene Editor -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">
                        Scenes (<span x-text="scenes.length"></span>)
                    </h3>
                    <button @click="generateVideo()"
                            :disabled="scenes.length === 0"
                            class="bg-primary-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        Generate Video
                    </button>
                </div>

                <!-- Scene List -->
                <div class="space-y-4">
                    <template x-for="(scene, index) in scenes" :key="index">
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm font-medium text-gray-500">#<span x-text="index + 1"></span></span>
                                    <span class="text-lg" x-text="getSceneIcon(scene.type)"></span>
                                    <span class="font-medium text-gray-900" x-text="getSceneName(scene.type)"></span>
                                </div>
                                <div class="flex space-x-2">
                                    <button @click="moveScene(index, -1)"
                                            :disabled="index === 0"
                                            class="p-1 text-gray-400 hover:text-gray-600 disabled:opacity-30">
                                        ↑
                                    </button>
                                    <button @click="moveScene(index, 1)"
                                            :disabled="index === scenes.length - 1"
                                            class="p-1 text-gray-400 hover:text-gray-600 disabled:opacity-30">
                                        ↓
                                    </button>
                                    <button @click="removeScene(index)"
                                            class="p-1 text-red-400 hover:text-red-600">
                                        ×
                                    </button>
                                </div>
                            </div>

                            <!-- Scene Form (Dynamic based on type) -->
                            <div class="space-y-3">
                                <!-- Title Scene -->
                                <template x-if="scene.type === 'title'">
                                    <div class="space-y-3">
                                        <input type="text" x-model="scene.title" placeholder="Title" class="w-full px-3 py-2 border border-gray-300 rounded">
                                        <input type="text" x-model="scene.subtitle" placeholder="Subtitle" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    </div>
                                </template>

                                <!-- Command Scene -->
                                <template x-if="scene.type === 'command'">
                                    <div class="space-y-3">
                                        <input type="text" x-model="scene.title" placeholder="Title" class="w-full px-3 py-2 border border-gray-300 rounded">
                                        <input type="text" x-model="scene.description" placeholder="Description" class="w-full px-3 py-2 border border-gray-300 rounded">
                                        <textarea x-model="scene.commands" rows="3" placeholder="Commands (one per line)" class="w-full px-3 py-2 border border-gray-300 rounded"></textarea>
                                    </div>
                                </template>

                                <!-- List Scene -->
                                <template x-if="scene.type === 'list'">
                                    <div class="space-y-3">
                                        <input type="text" x-model="scene.title" placeholder="Title" class="w-full px-3 py-2 border border-gray-300 rounded">
                                        <textarea x-model="scene.items" rows="4" placeholder="Items (one per line)" class="w-full px-3 py-2 border border-gray-300 rounded"></textarea>
                                    </div>
                                </template>

                                <!-- Outro Scene -->
                                <template x-if="scene.type === 'outro'">
                                    <div class="space-y-3">
                                        <input type="text" x-model="scene.message" placeholder="Message" class="w-full px-3 py-2 border border-gray-300 rounded">
                                        <input type="text" x-model="scene.cta" placeholder="Call to Action" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    </div>
                                </template>

                                <!-- Code Comparison Scene -->
                                <template x-if="scene.type === 'code_comparison'">
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <input type="text" x-model="scene.before_label" placeholder="Before Label (default: Before)" class="px-3 py-2 border border-gray-300 rounded text-sm">
                                            <input type="text" x-model="scene.after_label" placeholder="After Label (default: After)" class="px-3 py-2 border border-gray-300 rounded text-sm">
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Original Code</label>
                                                <textarea x-model="scene.before_code" rows="8" placeholder="def old():\n    pass" class="w-full px-3 py-2 border border-gray-300 rounded font-mono text-sm"></textarea>
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Refactored Code</label>
                                                <textarea x-model="scene.after_code" rows="8" placeholder="def new():\n    return True" class="w-full px-3 py-2 border border-gray-300 rounded font-mono text-sm"></textarea>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500">💡 Max 10 lines per side for readability</p>
                                    </div>
                                </template>

                                <!-- Quote Scene -->
                                <template x-if="scene.type === 'quote'">
                                    <div class="space-y-3">
                                        <textarea x-model="scene.quote_text" rows="4" placeholder="Quote text (e.g., 'Code is like humor...')" class="w-full px-3 py-2 border border-gray-300 rounded"></textarea>
                                        <input type="text" x-model="scene.attribution" placeholder="Attribution (optional, e.g., 'Cory House')" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    </div>
                                </template>

                                <!-- Learning Objectives Scene -->
                                <template x-if="scene.type === 'learning_objectives'">
                                    <div class="space-y-3">
                                        <input type="text" x-model="scene.title" placeholder="Lesson Title (e.g., 'Lesson Goals')" class="w-full px-3 py-2 border border-gray-300 rounded">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Learning Objectives (one per line, max 5)</label>
                                            <textarea x-model="scene.objectives" rows="5" placeholder="Understand variables&#10;Use basic data types&#10;Write simple functions" class="w-full px-3 py-2 border border-gray-300 rounded"></textarea>
                                        </div>
                                        <p class="text-xs text-gray-500">ℹ️ Each line becomes a bullet point (max 5 for readability)</p>
                                    </div>
                                </template>

                                <!-- Problem Scene -->
                                <template x-if="scene.type === 'problem'">
                                    <div class="space-y-3">
                                        <input type="text" x-model="scene.title" placeholder="Problem Title (e.g., 'Reverse a String')" class="w-full px-3 py-2 border border-gray-300 rounded">
                                        <textarea x-model="scene.problem_text" rows="4" placeholder="Problem description" class="w-full px-3 py-2 border border-gray-300 rounded"></textarea>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Difficulty (affects accent color in scene)</label>
                                            <select x-model="scene.difficulty" class="w-full px-3 py-2 border border-gray-300 rounded">
                                                <option value="easy">🟢 Easy (Green accent)</option>
                                                <option value="medium">🟡 Medium (Orange accent)</option>
                                                <option value="hard">🔴 Hard (Red accent)</option>
                                            </select>
                                        </div>
                                    </div>
                                </template>

                                <!-- Solution Scene -->
                                <template x-if="scene.type === 'solution'">
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Solution Code (one line per line, max 12)</label>
                                            <textarea x-model="scene.code" rows="8" placeholder="def reverse_string(s):\n    return s[::-1]" class="w-full px-3 py-2 border border-gray-300 rounded font-mono text-sm"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Explanation</label>
                                            <textarea x-model="scene.explanation" rows="3" placeholder="Explain how the solution works" class="w-full px-3 py-2 border border-gray-300 rounded"></textarea>
                                        </div>
                                    </div>
                                </template>

                                <!-- Exercise Scene -->
                                <template x-if="scene.type === 'exercise'">
                                    <div class="space-y-3">
                                        <input type="text" x-model="scene.title" placeholder="Exercise Title (e.g., 'Practice: Variables')" class="w-full px-3 py-2 border border-gray-300 rounded">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Instructions</label>
                                            <textarea x-model="scene.instructions" rows="3" placeholder="What the learner should do (e.g., 'Create three variables: name, age, city')" class="w-full px-3 py-2 border border-gray-300 rounded"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Hints (one per line, max 3)</label>
                                            <textarea x-model="scene.hints" rows="3" placeholder="Use descriptive names&#10;age should be an integer&#10;Use quotes for strings" class="w-full px-3 py-2 border border-gray-300 rounded"></textarea>
                                        </div>
                                    </div>
                                </template>

                                <!-- Checkpoint Scene -->
                                <template x-if="scene.type === 'checkpoint'">
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">✓ Learned Topics (max 6)</label>
                                                <textarea x-model="scene.learned_topics" rows="6" placeholder="Variables&#10;Data types&#10;Functions" class="w-full px-3 py-2 border border-gray-300 rounded"></textarea>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">→ Next Topics (max 6)</label>
                                                <textarea x-model="scene.next_topics" rows="6" placeholder="Classes&#10;Modules&#10;File I/O" class="w-full px-3 py-2 border border-gray-300 rounded"></textarea>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500">ℹ️ Left column: what was covered. Right column: what's coming next.</p>
                                    </div>
                                </template>

                                <!-- Quiz Scene -->
                                <template x-if="scene.type === 'quiz'">
                                    <div class="space-y-3">
                                        <input type="text" x-model="scene.question" placeholder="Question" class="w-full px-3 py-2 border border-gray-300 rounded">
                                        <textarea x-model="scene.options" rows="4" placeholder="Options (one per line, max 4)" class="w-full px-3 py-2 border border-gray-300 rounded"></textarea>
                                        <input type="text" x-model="scene.answer" placeholder="Correct Answer" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    </div>
                                </template>

                                <!-- Voice Selection -->
                                <select x-model="scene.voice" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                                    <option value="male">Andrew (Male)</option>
                                    <option value="male_warm">Brandon (Male Warm)</option>
                                    <option value="female">Aria (Female)</option>
                                    <option value="female_friendly">Ava (Female Friendly)</option>
                                </select>

                                <!-- Duration Controls (injected into all scene types) -->
                                <div class="pt-3 mt-3 border-t border-gray-200">
                                    <div class="text-xs font-medium text-gray-600 mb-2">
                                        ⏱️ Duration Control
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">
                                                Min Duration (s)
                                            </label>
                                            <input type="number"
                                                   x-model.number="scene.min_duration"
                                                   min="1" max="60" step="0.5"
                                                   placeholder="3.0"
                                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">
                                                Max Duration (s)
                                            </label>
                                            <input type="number"
                                                   x-model.number="scene.max_duration"
                                                   min="1" max="60" step="0.5"
                                                   placeholder="15.0"
                                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded">
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">
                                        ℹ️ System generates audio, then adjusts to fit duration range
                                    </p>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Empty State -->
                    <div x-show="scenes.length === 0" class="text-center py-12 text-gray-500">
                        <p>No scenes yet. Add your first scene from the left panel.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div x-show="generating"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         style="display: none;">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <svg class="animate-spin h-12 w-12 text-primary-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Generating Video</h3>
                <p class="text-gray-600 mb-4" x-text="progress.message"></p>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-primary-600 h-2 rounded-full transition-all duration-300"
                         :style="`width: ${progress.progress}%`"></div>
                </div>
                <p class="text-sm text-gray-500 mt-2"><span x-text="progress.progress"></span>%</p>
            </div>
        </div>
    </div>
</div>

<script>
    function sceneBuilder() {
        return {
            videoSet: {
                set_id: 'my_video',
                set_name: 'My Video',
                accent_color: 'blue'
            },
            scenes: [],
            generating: false,
            progress: {
                progress: 0,
                message: 'Starting...'
            },
            // Multilingual settings
            multilingualEnabled: false,
            sourceLanguage: 'en',
            targetLanguages: [],
            languageVoices: {},

            addScene(type) {
                const sceneTemplate = {
                    type: type,
                    voice: 'male',
                    min_duration: 3.0,  // Default min duration
                    max_duration: 15.0  // Default max duration
                };

                // Add type-specific defaults
                if (type === 'title') {
                    sceneTemplate.title = '';
                    sceneTemplate.subtitle = '';
                } else if (type === 'command') {
                    sceneTemplate.title = '';
                    sceneTemplate.description = '';
                    sceneTemplate.commands = '';
                } else if (type === 'list') {
                    sceneTemplate.title = '';
                    sceneTemplate.items = '';
                } else if (type === 'outro') {
                    sceneTemplate.message = '';
                    sceneTemplate.cta = '';
                } else if (type === 'code_comparison') {
                    sceneTemplate.before_code = '';
                    sceneTemplate.after_code = '';
                    sceneTemplate.before_label = 'Before';
                    sceneTemplate.after_label = 'After';
                } else if (type === 'quote') {
                    sceneTemplate.quote_text = '';
                    sceneTemplate.attribution = '';
                } else if (type === 'learning_objectives') {
                    sceneTemplate.title = '';
                    sceneTemplate.objectives = '';
                } else if (type === 'problem') {
                    sceneTemplate.title = '';
                    sceneTemplate.problem_text = '';
                    sceneTemplate.difficulty = 'medium';
                } else if (type === 'solution') {
                    sceneTemplate.code = '';
                    sceneTemplate.explanation = '';
                } else if (type === 'exercise') {
                    sceneTemplate.title = '';
                    sceneTemplate.instructions = '';
                    sceneTemplate.hints = '';
                } else if (type === 'checkpoint') {
                    sceneTemplate.learned_topics = '';
                    sceneTemplate.next_topics = '';
                } else if (type === 'quiz') {
                    sceneTemplate.question = '';
                    sceneTemplate.options = '';
                    sceneTemplate.answer = '';
                }

                this.scenes.push(sceneTemplate);
            },

            removeScene(index) {
                this.scenes.splice(index, 1);
            },

            moveScene(index, direction) {
                const newIndex = index + direction;
                if (newIndex >= 0 && newIndex < this.scenes.length) {
                    const temp = this.scenes[index];
                    this.scenes[index] = this.scenes[newIndex];
                    this.scenes[newIndex] = temp;
                }
            },

            getSceneIcon(type) {
                const icons = {
                    title: '🎬',
                    command: '💻',
                    list: '📋',
                    outro: '✅',
                    code_comparison: '🔄',
                    quote: '💬',
                    learning_objectives: '🎯',
                    problem: '❓',
                    solution: '💡',
                    checkpoint: '✓',
                    quiz: '📝',
                    exercise: '💪'
                };
                return icons[type] || '📄';
            },

            getSceneName(type) {
                const names = {
                    title: 'Title Slide',
                    command: 'Command/Code',
                    list: 'List Items',
                    outro: 'Outro/CTA',
                    code_comparison: 'Code Comparison',
                    quote: 'Quote',
                    learning_objectives: 'Learning Objectives',
                    problem: 'Problem',
                    solution: 'Solution',
                    checkpoint: 'Checkpoint',
                    quiz: 'Quiz',
                    exercise: 'Exercise'
                };
                return names[type] || type;
            },

            getLanguageName(code) {
                const languageNames = {
                    en: 'English', es: 'Spanish', fr: 'French', de: 'German',
                    it: 'Italian', pt: 'Portuguese', nl: 'Dutch', ru: 'Russian',
                    ja: 'Japanese', zh: 'Chinese', ko: 'Korean', ar: 'Arabic',
                    hi: 'Hindi', tr: 'Turkish', pl: 'Polish', sv: 'Swedish',
                    no: 'Norwegian', da: 'Danish', fi: 'Finnish', el: 'Greek',
                    he: 'Hebrew', th: 'Thai', vi: 'Vietnamese', id: 'Indonesian',
                    ms: 'Malay', tl: 'Filipino', cs: 'Czech', hu: 'Hungarian'
                };
                return languageNames[code] || code;
            },

            async generateVideo() {
                if (this.scenes.length === 0) return;

                this.generating = true;
                this.progress = { progress: 0, message: 'Preparing...' };

                // Transform scenes to API format
                const transformedScenes = this.scenes.map(scene => {
                    const transformed = { ...scene };

                    // Convert string arrays to actual arrays
                    if (scene.commands && typeof scene.commands === 'string') {
                        transformed.commands = scene.commands.split('\n').filter(c => c.trim());
                    }
                    if (scene.items && typeof scene.items === 'string') {
                        transformed.items = scene.items.split('\n').filter(i => i.trim());
                    }
                    if (scene.content && typeof scene.content === 'string') {
                        transformed.content = scene.content.split('\n').filter(c => c.trim());
                    }
                    // New scene types - convert string arrays
                    if (scene.objectives && typeof scene.objectives === 'string') {
                        transformed.objectives = scene.objectives.split('\n').filter(o => o.trim());
                    }
                    if (scene.hints && typeof scene.hints === 'string') {
                        transformed.hints = scene.hints.split('\n').filter(h => h.trim());
                    }
                    if (scene.learned_topics && typeof scene.learned_topics === 'string') {
                        transformed.learned_topics = scene.learned_topics.split('\n').filter(t => t.trim());
                    }
                    if (scene.next_topics && typeof scene.next_topics === 'string') {
                        transformed.next_topics = scene.next_topics.split('\n').filter(t => t.trim());
                    }
                    if (scene.options && typeof scene.options === 'string') {
                        transformed.options = scene.options.split('\n').filter(o => o.trim());
                    }
                    // Code fields - convert to arrays
                    if (scene.before_code && typeof scene.before_code === 'string') {
                        transformed.before_code = scene.before_code.split('\n');
                    }
                    if (scene.after_code && typeof scene.after_code === 'string') {
                        transformed.after_code = scene.after_code.split('\n');
                    }
                    if (scene.code && typeof scene.code === 'string') {
                        transformed.code = scene.code.split('\n');
                    }

                    return transformed;
                });

                const payload = {
                    set_id: this.videoSet.set_id,
                    set_name: this.videoSet.set_name,
                    accent_color: this.videoSet.accent_color,
                    videos: [{
                        video_id: this.videoSet.set_id,
                        title: this.videoSet.set_name,
                        scenes: transformedScenes
                    }]
                };

                // Add multilingual configuration if enabled
                if (this.multilingualEnabled && this.targetLanguages.length > 0) {
                    payload.multilingual = {
                        enabled: true,
                        source_language: this.sourceLanguage,
                        target_languages: this.targetLanguages
                    };

                    // Add per-language voice assignments if configured
                    const voiceAssignments = {};
                    for (const lang of this.targetLanguages) {
                        if (this.languageVoices[lang]) {
                            voiceAssignments[lang] = this.languageVoices[lang];
                        }
                    }
                    if (Object.keys(voiceAssignments).length > 0) {
                        payload.multilingual.voice_mapping = voiceAssignments;
                    }
                }

                try {
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    if (data.task_id) {
                        // Start SSE connection
                        const eventSource = new EventSource(`/api/tasks/${data.task_id}/stream`);

                        eventSource.onmessage = (event) => {
                            const progress = JSON.parse(event.data);
                            this.progress = progress;

                            if (progress.status === 'complete') {
                                eventSource.close();
                                setTimeout(() => {
                                    alert('Video generated successfully!');
                                    this.generating = false;
                                }, 1000);
                            } else if (progress.status === 'failed') {
                                eventSource.close();
                                alert('Generation failed: ' + progress.message);
                                this.generating = false;
                            }
                        };
                    }
                } catch (error) {
                    // Handle both string and object errors
                    let errorMessage = error.message || 'Unknown error';
                    if (error.detail) {
                        if (Array.isArray(error.detail)) {
                            errorMessage = error.detail.map(err => err.msg || JSON.stringify(err)).join(', ');
                        } else if (typeof error.detail === 'string') {
                            errorMessage = error.detail;
                        } else {
                            errorMessage = JSON.stringify(error.detail);
                        }
                    }
                    alert('Error: ' + errorMessage);
                    this.generating = false;
                }
            }
        }
    }
</script>
{% endblock %}
